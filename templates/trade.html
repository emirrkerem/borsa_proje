{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Hisse Ekle</h2>
    <form id="tradeForm">
        <input type="text" id="stockSymbol" placeholder="Hisse Sembolü" oninput="fetchStockPrice()">
        <select id="action">
            <option value="Alış">Alış</option>
            <option value="Satış">Satış</option>
        </select>
        <input type="number" id="quantity" placeholder="Miktar">
        <input type="text" id="price" placeholder="Fiyat" readonly>
        <button type="button" onclick="addTrade()">Ekle</button>
    </form>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" placeholder="Miktar" name="quantity" id="quantity">
        </div>
        <div class="col-md-2">
            <input type="number" step="0.01" class="form-control" placeholder="Giriş Fiyatı" name="entry_price" id="entry_price">
        </div>
        <div class="col-md-2 d-flex justify-content-center">
            <button type="button" class="btn btn-primary" id="addTrade">Ekle</button>      
        </div>
    </form>
</div>

<!-- Hisse Fiyatını Getir -->
<div class="stock-price-container">
    <input type="text" id="stockSymbol" placeholder="Hisse Sembolü">
    <button class="btn btn-primary" onclick="getStockPrice()">Fiyatı Getir</button>
    <p>Güncel Fiyat: <span id="stockPrice">-</span></p>
</div>

<!-- JavaScript ile API'den Fiyat Çekme -->
<script>
    function getStockPrice() {
        let symbol = document.getElementById("stockSymbol").value;
        if (!symbol) {
            alert("Lütfen bir hisse sembolü girin!");
            return;
        }

        fetch(`/get_stock_price?symbol=${symbol}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Hata: " + data.error);
                } else {
                    document.getElementById("stockPrice").innerText = "$" + data.price;
                }
            })
            .catch(error => console.error("Hata:", error));
    }
</script>

    <!-- Trade Tablosu -->
<div class="container mt-4">
    <table class="table table-dark table-striped" id="tradeTable">
        <thead>
            <tr>
                <th>Trades</th>
                <th>Action</th>
                <th>Miktar</th>
                <th>Tarih</th>
                <th>Fiyat</th>
                <th>Toplam Maliyet</th>
                <th>Çıkış Fiyatı</th>               
                <th>Kâr/Zarar</th>                
            </tr>
        </thead>
        <tbody></tbody>
            <!-- Eklenen işlemler buraya dinamik olarak eklenecek -->
        </tbody>
    </table>
</div>

<script>
    function addTrade() {
        let symbol = document.getElementById("symbol").value;
        let quantity = document.getElementById("quantity").value;
        let buyPrice = document.getElementById("buy_price").value;
        let sellPrice = document.getElementById("sell_price").value;
        let date = new Date().toISOString().split('T')[0]; // Bugünün tarihi

        // Kâr/Zarar hesapla
        let profitLoss = ((sellPrice - buyPrice) / buyPrice * 100).toFixed(2);
        let profitClass = profitLoss >= 0 ? 'profit' : 'loss';

        // Yeni satırı ekle
        let table = document.getElementById("tradeTableBody");
        let row = `<tr>
                    <td>${date}</td>
                    <td>${symbol}</td>
                    <td>${quantity}</td>
                    <td>${buyPrice}</td>
                    <td>${sellPrice}</td>
                    <td class="${profitClass}">${profitLoss}%</td>
                    <td><button onclick="deleteRow(this)">Sil</button></td>
                  </tr>`;
        table.innerHTML += row;

        // Formu temizle
        document.getElementById("tradeForm").reset();
    }

    function deleteRow(button) {
        button.parentElement.parentElement.remove();
    }
</script>

{% endblock %}


